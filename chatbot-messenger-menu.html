<script type="text/javascript">
  RED.nodes.registerType('chatbot-messenger-menu', {
    category: 'RedBot',
    color: '#FFCC66',
    defaults: {
      name: {
        value: ''
      },
      items: {
        value: [],
        validate: function(items) {
          var valid = true;
          var idx;
          for(idx = 0; idx < items.length; idx++) {
            if (!$.RedBot.validate.button(items[idx])) {
              valid = false;
            }
          }
          return valid;
        }
      },
      message: {
        value: ''
      }
    },
    inputs: 1,
    outputs: 1,
    paletteLabel: 'Messenger Menu',
    icon: 'chatbot-menu.png',
    label: function() {
      return this.name || 'Messenger Menu';
    },
    oneditsave: function() {
      var items = $("#node-input-items-container").editableList('items');
      var node = this;
      node.items = [];
      var idx;
      for(idx = 0; idx < items.length; idx++) {
        node.items.push($(items[idx]).RB_getButtonData());
      }
    },
    oneditprepare: function() {
      $('#node-input-items-container').css('min-height','300px').css('min-width','450px').editableList({
        addButton: 'Add menu item',
        addItem: function(container, i, item) {
          $(container).RB_mountButtonDialog({
            types: ['postback', 'url'],
            badges: false,
            platforms: ['facebook']
          });
          $(container).RB_setButtonData(item, {
            badges: false
          });
        },
        removable: true,
        sortable: true
      });
      if (this.items != null) {
        this.items.forEach(function(item) {
          $('#node-input-items-container').editableList('addItem', item);
        });
      }
    },
    oneditresize: function() {
      var dialogForm = $('#dialog-form');
      var rowName = $('.form-row-name', dialogForm);
      var rowLabel = $('.form-row-label', dialogForm);
      var height = dialogForm.height() - rowName.height() - rowLabel.height() - 20;
      $('#node-input-items-container').editableList('height', height);
    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-messenger-menu">
<div class="form-row form-row-name">
  <label for="node-input-name"><i class="icon-tag"></i> Name</label>
  <input type="text" id="node-input-name" placeholder="Name">
</div>
<div class="form-row form-row-label" style="margin-bottom:0;">
  <label><i class="fa fa-list"></i> <span>Buttons</span></label>
</div>
<div class="form-row node-input-rule-container-row">
  <ol id="node-input-items-container"></ol>
</div>
</script>

<script type="text/x-red" data-help-name="chatbot-messenger-menu">
<p>Facebook Messenger persistent menu <em>[Facebook]</em>.</p>
<p>This will set the persistent menu next to the editable area in Facebook Messenger, there two kind of options:</p>
<ul>
<li><b>Web Url:</b> it opens a specific url. In the mobile version it's possible to specify the size of the browser window<.
Also supports <a target="_blank" href="https://developers.facebook.com/docs/messenger-platform/webview">Messenger Extensions</a>./li>
<li><b>Postback:</b> sends the text defined in "payload" field to the chat</li>
</ul>
Maximum 3 menu items.
<p>
The menu can be passed through the payload by the upstream node:
</p>
<pre>
msg.payload = [
  {
    type: 'url',
    title: 'JavaScript Jedi',
    url: 'http://javascript-jedi.com',
    webview_height_ratio: 'full' // tall|full|compact
  },
  {
    type: 'postback',
    title: 'Help',
    payload: '/help'
  }
];
return msg;
</pre>
</p>
</script>




