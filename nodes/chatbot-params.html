<script type="text/javascript">

  var mountControl = function(container, param, defaultParam, callback) {
    container.empty();
    switch(param.type) {
      case 'string':
        container.append(
          '<div class="form-row" style="display:inline-block;margin-left:10px;">'
          + '<input type="text" value="' + (defaultParam != null ? defaultParam : '') 
          + '" autocomplete="disable" style="width:100%;" placeholder="' + (!_.isEmpty(param.placeholder) ? param.placeholder : '') + '">'
          + '</div>');
        $('input', container)
          .keyup(function() {
            callback($(this).val());
          });
        break;
      case 'boolean':        
        container.append(
          '<div class="form-row" style="display:inline-block;margin-left:10px;">'
          + '<input type="radio" name="radio_' + param.name + '" value="true" style="width:20px;margin-top:-2px;"> Yes'
          + '<input type="radio" name="radio_' + param.name + '" value="false" style="width:20px;margin-top:-2px;margin-left:5px;"> No'    
          + '</div>'
        );
        $('input', container)
          .click(function() {
            callback($(this).attr('value') === 'true');
          });
        if (defaultParam === true || defaultParam === 'true') {
          $('input[type=radio][value=true]', container).attr('checked', true);
        } else if (defaultParam === false || defaultParam === 'false') {
          $('input[type=radio][value=false]', container).attr('checked', true);
        }  
        break;
    }
  }

  var buildParam = function(row, platform, current) {
    var node = this;
    var params = node.availableParams[platform];
    var idx = 0;
    var tooltip = null;

    var platformDefinition = null;
    for(idx = 0; idx < node.platforms.length; idx++) {
      if (node.platforms[idx].id === platform) {
        platformDefinition = node.platforms[idx];
      }
    }

    var paramsOptions = '';
    for(idx = 0; idx < params.length; idx++) {
      paramsOptions += '<option value="' + params[idx].name + '">' + params[idx].label + '</option>';
    }

    row.empty()
      .append('<span class="platform" '
        + 'style="font-size:10px;background-color:' 
        + (platformDefinition != null && platformDefinition.color != null ? platformDefinition.color : '#bbbbbb') 
        + ';padding: 2px 3px 2px 3px;border-radius:2px;text-transform:uppercase;color:#ffffff;margin-left:5px;"'
        + '>' 
        + platform + '</span>')
      .append('<select class="param-name" name="transport" style="width:40%;margin-left:10px;">'
            + '<option value="">Select parameter</option>'
            + paramsOptions
            + '</select>')
      .append('<input class="value" type="hidden" name="" value="">')
      .append('<input class="type" type="hidden" name="type" value="">')
      .append('<span class="hint" style="margin-left:8px;display:inline-block;"><i class="fa fa-question-circle" style="color:#999999;"/></div>')
      .append('<div class="control" style="display:inline-block;height:34px;width:35%;">&nbsp;</div>');
      $('.hint', row).hide();

    $('select.param-name', row)
      .change(function() {
        var param = $(this).val();
        var paramObj = null;

        for(idx = 0; idx < params.length; idx++) {
          if (params[idx].name === param) {
            paramObj = params[idx];
          }
        }
        if (paramObj != null) {
          $('input[type=hidden].value', row).attr('name', param);
          $('input[type=hidden].type', row).attr('value', paramObj.type);
          mountControl($('.control', row), paramObj, paramObj.default != null ? paramObj.default : null, function(value) {
            $('input[type=hidden].value', row).attr('value', value);
          });
          if (paramObj.description != null) {
            if (tooltip != null) {
              tooltip.dispose();
              tooltip = null;
            }
            tooltip = new Tooltip($('.hint', row).get(0), {
              placement: 'right-start', 
              title: paramObj.description,
              trigger: 'hover'
            });
            $('.hint', row).show();
          } else {
            $('.hint', row).hide();
            if (tooltip != null) {
              tooltip.dispose();
              tooltip = null;
            }
          }
        }
      });

    if (current != null) {
      var paramObj = null;
      for(idx = 0; idx < params.length; idx++) {
        if (params[idx].name === current.name) {
          paramObj = params[idx];
        }
      }
      $('input[type=hidden].type', row).attr('value', paramObj.type);
      $('input[type=hidden].value', row).attr('name', current.name);
      $('input[type=hidden].value', row).attr('value', current.value);
      $('select.param-name', row).val(current.name);
      mountControl($('.control', row), paramObj, current.value, function(value) {
        $('input[type=hidden].value', row).attr('value', value);
      });
      if (paramObj.description != null) {
        if (tooltip != null) {
          tooltip.dispose();
          tooltip = null;
        }
        tooltip = new Tooltip($('.hint', row).get(0), {
          placement: 'right-start',
          title: paramObj.description,
          trigger: 'hover'
        });
        $('.hint', row).show();
      }
    }
  }

  var buildParams = function() {
    var node = this;

    $("#node-input-params-container").css('min-height','250px').css('min-width','450px').editableList({
      addButton: 'Add parameter',
      addItem: function (container, i, opt) {
        // build rule row
        var param = opt;
        var isEmpty = param.platform == null;
        // empty row
        var row = $('<div/>').appendTo(container);
        if (!isEmpty) {
          buildParam.call(node, row, param.platform, param);
          return;
        } else {
          // build transport options
          var transportOptions = '';
          for(idx = 0; idx < node.platforms.length; idx++) {
            // only if some parameters
            if (node.availableParams[node.platforms[idx].id] != null) {
              transportOptions += '<option value="' + node.platforms[idx].id + '">'
                + (node.platforms[idx].name != null ? node.platforms[idx].name : node.platforms[idx].id)
                + '</option>';
            }
          }
          row
            .append('<select class="transport" name="transport" style="width:40%;margin-left:10px;">'
              + '<option value="">Select transport</option>'
              + transportOptions
              + '</select>')
          $('select.transport', row)    
            .change(function() {
              buildParam.call(node, row, $(this).val());
            });
        }

      },
      removeItem: function(opt) {
        var rules = $('#node-input-params-container').editableList('items');
        rules.each(function(i) {
          $(this).find('.node-input-rule-index').html(i + 1);
        });
      },
      sortItems: function() {
        var rules = $('#node-input-params-container').editableList('items');
        rules.each(function(i) {
          $(this).find('.node-input-rule-index').html(i + 1);
        });
      },
      sortable: false,
      removable: true
    });

    for (var i=0; i < node.params.length; i++) {
      var param = this.params[i];
      $('#node-input-params-container').editableList('addItem', param);
    }
  };

  $.RedBot.registerType('chatbot-params', {
    category: $.RedBot.config.name + ' Flow',
    color: '#FFCC66',
    defaults: {
      name: {
        value: ''
      },
      params: {
        value: [],
        validate: function(params) {
          return $.RedBot.validate.params(params);
        }
      },
      outputs: {
        value: 1
      }
    },
    inputs: 1,
    outputs: 1,
    paletteLabel: 'Params',
    icon: 'chatbot-params.png',
    label: function() {
      return this.name || 'Params' ;
    },
    oneditsave: function() {
      var params = $('#node-input-params-container').editableList('items');
      var node = this;
      node.params = [];
      params.each(function(i) {
        var paramRow = $(this);
        var platform = paramRow.find('.platform').text();
        var name = paramRow.find('input[type=hidden].value').attr('name');
        var value = paramRow.find('input[type=hidden].value').attr('value');
        var type = paramRow.find('input[type=hidden].type').attr('value');
        
        // do some conversion
        if (type === 'boolean') {
          value = value === 'true' || value === true;
        }
        node.params.push({
          platform: platform,
          name: name,
          value: value
        });      
      });
    },

    oneditprepare: function() {
      var node = this;
      var nodeRedUrl = '';

      if (RED.settings.httpNodeRoot) {
        nodeRedUrl = RED.settings.httpNodeRoot;
      }

      $.get(nodeRedUrl + 'redbot/globals')
        .done(function(response) {
          node.messageTypes = response.messageTypes;
          node.eventTypes = response.eventTypes;
          node.availableParams = response.params;
          $.RedBot.fetchPlatforms()
            .done(function(platforms) {
              node.platforms = platforms;
              buildParams.call(node);
            });
        });
    },
    oneditresize: function() {
      var dialogForm = $('#dialog-form');
      var rowName = $('.form-row-name', dialogForm);
      var rowLabel = $('.form-row-label', dialogForm);
      var rowHint = $('.redbot-form-hint', dialogForm);
      var height = dialogForm.height() - rowName.height() - rowLabel.height() - rowHint.height() - 30;
      $('#node-input-params-container').editableList('height', height);
    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-params">
  <div class="form-row form-row-name">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row form-row-label">
    <label for="node-input-name" style="width:100%;">Add parameter to the chat flow:</label>
  </div>
  <div class="form-row node-input-params-container-row">
      <ol id="node-input-params-container"></ol>
  </div>
</script>

<script type="text/x-red" data-help-name="chatbot-params">
</script>


