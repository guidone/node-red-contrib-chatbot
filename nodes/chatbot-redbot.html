<script type="text/javascript">
  $.RedBot = {
    registerType: function(type, params) {
      var hiddenNodes = $.RedBot.config.hideNodes || [];
      if (hiddenNodes.indexOf(type) !== -1) {
        console.log('Skipped node "' + type + '" due to configuration in redbot.config.html');
      } else {
        RED.nodes.registerType(type, params);
      }
    }
  };
  $.RedBot.buttonTypes = [
    {
      type: 'url',
      label: 'URL',
      className: 'platform-combo-telegram-facebook-viber',
      platforms: ['facebook', 'telegram', 'viber']
    },
    {
      type: 'postback',
      label: 'Postback',
      className: 'platform-combo-telegram-facebook-slack-viber',
      platforms: ['facebook', 'telegram', 'slack', 'viber']
    },
    {
      type: 'dialog',
      label: 'Open Dialog',
      className: 'platform-combo-slack',
      platforms: ['slack']
    },
    {
      type: 'quick-reply',
      label: 'Postback',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'location',
      label: 'Location',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'call',
      label: 'Phone Call',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'share',
      label: 'Share',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'login',
      label: 'Log In',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'logout',
      label: 'Log Out',
      className: 'platform-combo-facebook',
      platforms: ['facebook']
    },
    {
      type: 'newline',
      label: 'New row of buttons',
      className: 'platform-combo-telegram-viber',
      platforms: ['telegram', 'viber']
    },
    {
      type: 'keyboardButton',
      label: 'Keyboard Button',
      className: 'platform-combo-telegram',
      platforms: ['telegram']
    }
  ];
  $.RedBot.elementTypes = [
    {
      type: 'text',
      label: 'Text',
      className: 'platform-slack',
      platforms: ['slack']
    },
    {
      type: 'textarea',
      label: 'Textarea',
      className: 'platform-slack',
      platforms: ['slack']
    },
    {
      type: 'select',
      label: 'Select',
      className: 'platform-slack',
      platforms: ['slack']
    }
  ];
  $.RedBot.validate = {};
  $.RedBot.validate.isVariable = function(value) {
    return $.RedBot.validate.string(value) && value.match(/^\{\{[A-Za-z0-9_-]*\}\}$/) != null;
  };
  $.RedBot.validate.number = function(value) {
    return typeof value === 'number';
  };
  $.RedBot.validate.string = function(value) {
    return typeof value === 'string';
  };
  $.RedBot.validate.email = function(value) {
    return typeof value === 'string' && value !== '' && value.indexOf('@') !== -1;
  };
  $.RedBot.validate.privateKey = function(value) {
    return $.RedBot.validate.string(value)
      && value.indexOf('-----BEGIN PRIVATE KEY-----') !== -1
      && value.indexOf('-----END PRIVATE KEY-----') !== -1;
  };
  $.RedBot.validate.numberOrVariable = function(value) {
    return $.RedBot.validate.number(value)
      ||
      ($.RedBot.validate.notEmpty(value) && !isNaN(parseFloat(value)))
      ||
      ($.RedBot.validate.notEmpty(value) && $.RedBot.validate.isVariable(value));
  };
  $.RedBot.validate.price = function(price) {
    return price != null
      && $.RedBot.validate.notEmpty(price.label)
      && $.RedBot.validate.numberOrVariable(price.amount);
  };
  $.RedBot.validate.prices = function(prices) {
    if (prices == null) {
      return false;
    }
    var valid = true;
    var idx;
    for(idx = 0; idx < prices.length; idx++) {
      if (!$.RedBot.validate.price(prices[idx])) {
        valid = false;
      }
    }
    return valid;
  };
  $.RedBot.validate.notEmpty = function(str) {
    return str != null && str != '';
  };
  $.RedBot.validate.isEmpty = function(str) {
    return str == null || str.length === 0;
  };
  $.RedBot.validate.url = function(url) {
    return url != null && url.match(/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi);
  };
  $.RedBot.validate.arrayNotEmpty = function(array) {
    return array != null && array.length !== 0;
  };
  $.RedBot.validate.element = function(element) {
    if (element == null) {
      return false;
    }
    switch(element.type) {
      case 'text':
      case 'textarea':
        return $.RedBot.validate.notEmpty(element.name) && $.RedBot.validate.notEmpty(element.label);
      case 'select':
        return $.RedBot.validate.notEmpty(element.name) && $.RedBot.validate.notEmpty(element.label)
          && $.RedBot.validate.options(element.options);
      default:
        return false;
    }
  };
  $.RedBot.validate.options = function(options) {
    if (options == null || options.length == null || options.length === 0) {
      return false;
    }
    var idx;
    var result = true;
    for(idx = 0; idx < options.length; idx++) {
      if (!($.RedBot.validate.notEmpty(options[idx].value) && $.RedBot.validate.notEmpty(options[idx].label))) {
        result = false;
      }
    }
    return result;
  };
  $.RedBot.validate.button = function(button) {
    if (button == null) {
      return false;
    }
    switch(button.type) {
      case 'url':
        return $.RedBot.validate.notEmpty(button.label) && $.RedBot.validate.url(button.url);
      case 'postback':
        return $.RedBot.validate.notEmpty(button.label) && $.RedBot.validate.notEmpty(button.value);
      case 'dialog':
        return $.RedBot.validate.notEmpty(button.label) && $.RedBot.validate.notEmpty(button.value);
      case 'quick-reply':
        return $.RedBot.validate.notEmpty(button.label) && $.RedBot.validate.notEmpty(button.value);
      case 'call':
        return $.RedBot.validate.notEmpty(button.label) && $.RedBot.validate.notEmpty(button.number);
      case 'keyboardButton':
        return $.RedBot.validate.notEmpty(button.label);
      case 'newline':
      case 'share':
      case 'logout':
      case 'location':
        return true;
      case 'login':
        return $.RedBot.validate.url(button.url);
      default:
        return false;
    }
  };
  $.RedBot.validate.confirmationStatus = function(status) {
    return ['none', 'confirmed', 'denied'].indexOf(status) !== -1;
  };
  $.RedBot.validate.rule = function(rule) {
    if (rule == null) {
      return false;
    }
    switch(rule.type) {
      case 'isSlotConfirmationStatus':
        return $.RedBot.validate.notEmpty(rule.slot) && $.RedBot.validate.confirmationStatus(rule.confirmationStatus);
      case 'isIntentConfirmationStatus':
        return $.RedBot.validate.confirmationStatus(rule.confirmationStatus);
      case 'dialogState':
        return $.RedBot.validate.notEmpty(rule.state);
      case 'environment':
        return $.RedBot.validate.notEmpty(rule.environment);
      case 'topicIncludes':
      case 'isNotTopic':
      case 'isTopic':
        return $.RedBot.validate.notEmpty(rule.topic);
      case 'isVariable':
        return $.RedBot.validate.notEmpty(rule.value) && $.RedBot.validate.notEmpty(rule.variable);
      case 'hasNotVariable':
      case 'hasVariable':
        return $.RedBot.validate.notEmpty(rule.variable);
      case 'command':
        return $.RedBot.validate.notEmpty(rule.command);
      case 'messageType':
        return $.RedBot.validate.notEmpty(rule.messageType);
      case 'isTransportPreferred':
      case 'isTransportAvailable':
      case 'transport':
        return $.RedBot.validate.notEmpty(rule.transport);
      case 'messageEvent':
        return $.RedBot.validate.notEmpty(rule.event);
      case 'isIntentName':
        return $.RedBot.validate.notEmpty(rule.intent);
      case 'isIntent':
      case 'outbound':
      case 'inbound':
      case 'isTopicEmpty':
      case 'catchAll':
      case 'pending':
      case 'notPending':
      case 'anyCommand':
        return true;
      default:
        return false;
    }
  };
  $.RedBot.validate.rules = function(rules) {
    if (rules == null) {
      return false;
    }
    var valid = true;
    var idx;
    for(idx = 0; idx < rules.length; idx++) {
      if (!$.RedBot.validate.rule(rules[idx])) {
        valid = false;
      }
    }
    return valid;
  };
  $.RedBot.validate.param = function(param) {
    return param != null && param.platform != null && param.name != null && param.value != null;  
  };
  $.RedBot.validate.params = function(params) {
    if (params == null) {
      return false;
    }
    var valid = true;
    var idx;
    for(idx = 0; idx < params.length; idx++) {
      if (!$.RedBot.validate.param(params[idx])) {
        valid = false;
      }
    }
    return valid;
  };
  $.RedBot.buttonTypes.findButton = function(type) {
    var button = null;
    this.forEach(function(current) {
      if (current.type === type) {
        button = current;
      }
    });
    return button;
  };
  $.RedBot.elementTypes.findElement = function(type) {
    var element = null;
    this.forEach(function(current) {
      if (current.type === type) {
        element = current;
      }
    });
    return element;
  };
  $.RedBot.platforms = function(platforms, availablePlatforms) {
    var match = false;
    platforms.forEach(function(platform) {
      if (availablePlatforms.indexOf(platform) !== -1) {
        match = true;
      }
    });
    return match;
  };
  $.RedBot.intersect = function(array1, array2) {
    var result = [];
    var k = 0;
    // perhaps use ES6 set
    for(k = 0; k < array1.length; k++) {
      if (array2.indexOf(array1[k]) !== -1 && result.indexOf(array1[k]) === -1) {
        result.push(array1[k]);
      }
    }
    for(k = 0; k < array2.length; k++) {
      if (array1.indexOf(array2[k]) !== -1 && result.indexOf(array2[k]) === -1) {
        result.push(array2[k]);
      }
    }
    return result;
  };

  $.RedBot.platformClass = function(control, platforms) {

    var base = null;
    switch(control) {
      case 'select': base = 'platform-combo'; break;
      case 'icon': base = 'icon-platform'; break;
      case 'text': base = 'platform'; break;
      default:
        console.error('Unrecognized platform icon for type "' + control + '"');
        return '';
    }
    var platformClasses = [];
    if (platforms.indexOf('telegram') !== -1) {
      platformClasses.push('telegram');
    }
    if (platforms.indexOf('facebook') !== -1) {
      platformClasses.push('facebook');
    }
    if (platforms.indexOf('smooch') !== -1) {
      platformClasses.push('smooch');
    }
    if (platforms.indexOf('slack') !== -1) {
      platformClasses.push('slack');
    }
    if (platforms.indexOf('viber') !== -1) {
      platformClasses.push('viber');
    }
    if (platforms.indexOf('alexa') !== -1) {
      platformClasses.push('alexa');
    }
    if (platforms.indexOf('twilio') !== -1) {
      platformClasses.push('twilio');
    }
    if (platforms.indexOf('discord') !== -1) {
      platformClasses.push('discord');
    }
    return platformClasses.length !== 0 ? base + '-' + platformClasses.join('-') : '';
  };
  $.RB_Legend = function() {
    $('.redbot-form-legend').each(function() {
      var dom = $(this);
      dom.html('Some attributes apply for specific platform:<br>\n' +
        '  <span class="icon-platform-alexa"></span> = <span style="font-size:10px">Alexa</span>\n' +
        '  <span class="icon-platform-discord"></span> = <span style="font-size:10px">Discord</span>\n' +
        '  <span class="icon-platform-facebook"></span> = <span style="font-size:10px">Facebook</span>\n' +
        '  <span class="icon-platform-smooch"></span> = <span style="font-size:10px">Smooch</span>\n' +
        '  <span class="icon-platform-slack"></span> = <span style="font-size:10px">Slack</span>\n' +
        '  <span class="icon-platform-twilio"></span> = <span style="font-size:10px">Twilio</span>\n' +
        '  <span class="icon-platform-telegram"></span> = <span style="font-size:10px">Telegram</span>\n' +
        '  <span class="icon-platform-universal"></span> = <span style="font-size:10px">Universal</span>\n' +
        '  <span class="icon-platform-viber"></span> = <span style="font-size:10px">Viber</span>')
    });
  };

</script>
