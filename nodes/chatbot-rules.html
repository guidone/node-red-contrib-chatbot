<script type="text/javascript">
  RED.nodes.registerType('chatbot-rules', {
    category: 'RedBot Flow',
    color: '#FFCC66',
    defaults: {
      rules: {
        value: []
      },
      outputs: {
        value: 5
      }
    },
    inputs: 1,
    outputs: 5,
    paletteLabel: 'Rules',
    icon: 'chatbot-topic.png',
    label: function() {
      return 'Rules';
    },
    oneditsave: function() {
      var rules = $('#node-input-rule-container').editableList('items');
      var node = this;
      node.rules = [];
      rules.each(function(i) {
        var rule = $(this);
        var type = rule.find('select[name=type]').val();
        if (type != null && type !== '') {
          var obj = {
            type: type
          };
          if (type === 'has_not_variable') {
            obj.name = rule.find('input[name=name]').val();
          }
          if (type === 'is_not_topic') {
            obj.topic = rule.find('input[name=topic]').val();
          }
          node.rules.push(obj);
        }
      });
      console.log('---->', node.rules);
      this.outputs = node.rules.length;
    },
    oneditprepare: function() {
      var node = this;
      $("#node-input-rule-container").css('min-height','250px').css('min-width','450px').editableList({
        addItem: function (container, i, opt) {
          // build rule row
          var rule = opt;
          console.log('metto--->', rule);
          var row = $('<div/>').appendTo(container);
          row
            .append('<select name="type" style="width:40%">'
              + '<option value="">Select rule</option>'
              + '<option value="is_topic_empty">There is not topic</option>'
              + '<option value="is_not_topic">Is not topic</option>'
              + '<option value="has_not_variable">Variable not defined</option>'
              + '<option value="catch_all">If nothing of above applies</option>'
              + '</select>')
            .change(function() {
              var type = $('select[name=type]', container).val();
              container.find('input').hide();
              container.find('.' + type).show();
            });
          row
            .append('<input class="has_not_variable" style="display:none;width:40%;margin-left:10px;" type="text" name="name" placeholder="Context variable"/>')
            .append('<input class="is_not_topic" style="display:none;width:40%;margin-left:10px;" type="text" name="topic" placeholder="Topic"/>');
          var finalspan = $('<span/>',{style:"float: right;margin-top: 6px;"}).appendTo(row);
          finalspan.append('&nbsp;&#8594; <span class="node-input-rule-index">' + (i + 1) + '</span>');

          // finally set data
          if (rule.type != null) {
            $('select[name=type]', container).val(rule.type);
            container.find('input').hide();
            container.find('.' + rule.type).show();
          }
          if (rule.name != null) {
            $('input[name=name]', container).val(rule.name);
          }
          if (rule.topic != null) {
            $('input[name=topic]', container).val(rule.topic);
          }
        },
        removeItem: function(opt) {
          var rules = $('#node-input-rule-container').editableList('items');
          rules.each(function(i) {
            $(this).find('.node-input-rule-index').html(i + 1);
          });
        },
        sortItems: function() {
          var rules = $('#node-input-rule-container').editableList('items');
          rules.each(function(i) {
            $(this).find('.node-input-rule-index').html(i + 1);
          });
        },
        sortable: true,
        removable: true
      });

      for (var i=0; i < node.rules.length; i++) {
        var rule = this.rules[i];
        $('#node-input-rule-container').editableList('addItem', rule);
      }

    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-rules">
  <div class="form-row">
    <label for="node-input-name" style="width:100%;"><i class="fa fa-tag"></i> Forward message based on topic:</label>
  </div>
  <div class="form-row node-input-rule-container-row">
      <ol id="node-input-rule-container"></ol>
  </div>
  <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;clear:both;margin-top:5px;">
    Insert the topic to match (or a comma delimited list of topics).<br>
    The first matched topic skips the rest of the matching strings. To get a else-like behaviour, use a <code>*</code>
    at the end of the list to capture all messages that don't match any topic.
  </p>
  </div>
</script>

<script type="text/x-red" data-help-name="chatbot-rules">
  RULES

</script>


