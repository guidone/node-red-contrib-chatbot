<script type="text/javascript">
  var ChatbotSwitchTypes = [
    {value: '*', label: 'Any'},
    {value: 'action', label: 'Action'},
    {value: 'audio', label: 'Audio'},
    {value: 'buttons', label: 'Buttons'},
    {value: 'contact', label: 'Contact'},
    {value: 'document', label: 'Document'},
    {value: 'inline-buttons', label: 'Inline buttons'},
    {value: 'inline_query', label: 'Inline Query'},
    {value: 'location', label: 'Location'},
    {value: 'photo', label: 'Photo'},
    {value: 'request', label: 'Request'},
    {value: 'video', label: 'Video'}
  ];
  RED.nodes.registerType('chatbot-switch', {
    category: 'RedBot Flow',
    color: '#FFCC66',
    defaults: {
      rules: {
        value: [{type: ''}]
      },
      outputs: {
        value: 1
      }
    },
    inputs: 1,
    outputs: 1,
    paletteLabel: 'Switch',
    icon: 'chatbot-switch.png',
    label: function() {
      return 'Switch';
    },
    oneditsave: function() {
      var rules = $('#node-input-rules-container').editableList('items');
      var node = this;
      node.rules = [];
      rules.each(function(i) {
        var row = $(this);
        var type = row.find('select').val();
        if (type != null && type != '') {
          node.rules.push({type: type});
        }
      });
      this.outputs = node.rules.length;
    },
    outputLabels: function(index) {
      if (this.rules[index] != null && this.rules[index].type != null) {
        var rule = null;
        for(var idx = 0; idx < ChatbotSwitchTypes.length; idx++) {
          if (ChatbotSwitchTypes[idx].value === this.rules[index].type) {
            rule = ChatbotSwitchTypes[idx];
          }
        }
        if (rule != null) {
          return rule.label;
        }
      }
      return '';
    },
    oneditprepare: function() {
      var node = this;
      var rulesContainer = $('#node-input-rules-container');
      rulesContainer.css('min-height','250px').css('min-width','450px').editableList({
        addItem: function (container, i, opt) {
          var rule = opt;
          var idx;
          var row = $('<div/>').appendTo(container);
          var selectField = $('<select/>', {style:"width:80%; margin-left: 5px; text-align: left;"})
          for(idx = 0; idx < ChatbotSwitchTypes.length; idx++) {
            selectField.append('<option value="' + ChatbotSwitchTypes[idx].value + '">' + ChatbotSwitchTypes[idx].label + '</option>');
          }
          selectField.appendTo(row);
          if (rule.type != null) {
            selectField.val(rule.type);
          }
          var finalspan = $('<span/>',{style:"float: right;margin-top: 6px;"}).appendTo(row);
          finalspan.append('&nbsp;&#8594; <span class="node-input-rule-index">' + (i + 1) + '</span>');
        },
        removeItem: function(opt) {
          var rules = $('#node-input-rules-container').editableList('items');
          rules.each(function(i) {
            $(this).find('.node-input-rule-index').html(i + 1);
          });
        },
        sortItems: function() {
          var rules = $('#node-input-rules-container').editableList('items');
          rules.each(function(i) {
            $(this).find('.node-input-rule-index').html(i + 1);
          });
        },
        sortable: true,
        removable: true
      });

      for (var i=0; i < node.rules.length; i++) {
        var rule = this.rules[i];
        rulesContainer.editableList('addItem', rule);
      }

    }
  });
</script>

<script type="text/x-red" data-template-name="chatbot-switch">
  <div class="form-row">
    <label for="node-input-name" style="width:100%;"><i class="fa fa-tag"></i> Forward message based on topic:</label>
  </div>
  <div class="form-row node-input-rules-container-row">
      <ol id="node-input-rules-container"></ol>
  </div>
  <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;clear:both;margin-top:5px;">
    The first matched message type skips the rest of the matching rules. To get a else-like behaviour, use a <code>Any</code>
    at the end of the list to capture all messages that don't match any type.
  </p>
  </div>
</script>

<script type="text/x-red" data-help-name="chatbot-switch">
</script>


